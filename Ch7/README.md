# 视觉里程计part1 章节程序


- orb_cv.cpp 

    - 调用Opencv自带的ORB特征检测器，对图片进行特征提取后，使用Hamming距离进行暴力匹配。

    - ![image-20211225195452566](https://tuchuang-1998.oss-accelerate.aliyuncs.com/Picgo/image-20211225195452566.png)

- orb_self.cpp 

    - Opencv提取Fast角点，利用orbPartten计算质心与角度，使用Hamming距离进行暴力匹配。

- ![image-20211225195722638](https://tuchuang-1998.oss-accelerate.aliyuncs.com/Picgo/image-20211225195722638.png)


- pose_estimation_2d2d.cpp  本质矩阵和单应矩阵估计位姿

    - Opencv提取特征，Hamming距离暴力匹配。采用匹配好的坐标计算本质矩阵以及单应矩阵求解出`R,t`。利用求解出的`R,t`，对对极约束的方程进行验证，绘制本质矩阵`E`(旋转和平移)的误差大于`0.003`匹配结果。
    
    - 可以看出来误差大于`0.003`的匹配结果的匹配关系也是基本正确的，不存在明显的误匹配。因此可以认为对极约束的精度在`10-3`量级。 R,t结果如下所示
    
    - ```
      R is 
      [0.9985961798781875, -0.05169917220143663, 0.01152671359827834;
      0.05139607508976057, 0.9983603445075083, 0.02520051547522449;
      -0.01281065954813526, -0.02457271064688494, 0.9996159607036125]
      t is 
      [-0.822084106793334;
      -0.03269742706405415;
      0.5684264241053517]
      ```
    
    - 将本质矩阵*1000后分解得到的r,t仍然是正确的。也就是尺度不变性。
    
    - ![image-20211226104443788](https://tuchuang-1998.oss-accelerate.aliyuncs.com/Picgo/image-20211226104443788.png)


- triangulation_cv.cpp 三角化计算特征点的深度。


- pose_estimation_3d2d.cpp 使用pnp及优化算法求解位姿。

    - 首先对两张图像进行特征匹配，得到3D-2D匹配关系，一共67组3D-2D匹配点。分别调用OPENCV的`Epnp`,高斯牛顿pose BA,以及g2o进行求解。

    - 高斯牛顿法迭代5次收敛，耗时0.07ms。结果如下所示
    ```
    pose by g-n: 
    0.99813437583  -0.0609382196969   0.0037816883825  -0.0671195842092
    0.0609018188239    0.998102354943  0.00909161816373   0.0198340977527
    -0.0043285391053 -0.00884434492042    0.999951519481   0.0551992202289
    0                 0                 0                 1
    ```

    - OpenCV调用Epnp算法，耗时0.2816ms.结果如下所示
    ```
    Opencv solve R= 
    [0.9981343759390835, -0.06093821679995585, 0.003781706220472356;
    0.06090181567703748, 0.998102354940998, 0.00909163948219858;
    -0.004328558182181723, -0.008844365125643504, 0.9999515192196009]
    Opencv solve t= 
    [-0.06711961324309214;
    0.0198340652969387;
    0.05519921929828357]
    ```

    - g2o使用高斯牛顿求解ba问题，耗时0.26ms.结果如下所示
    ```
    iteration= 0	 chi2= 2029.946545	 time= 1.6786e-05	 cumTime= 1.6786e-05	 edges= 67	 schur= 0
    iteration= 1	 chi2= 1952.162508	 time= 7.472e-06	 cumTime= 2.4258e-05	 edges= 67	 schur= 0
    iteration= 2	 chi2= 1952.157900	 time= 8.08101e-06	 cumTime= 3.2339e-05	 edges= 67	 schur= 0
    
    pose estimated by g2o =
    0.998134375939  -0.0609382167943  0.00378170625156  -0.0671196132935
    0.0609018156709    0.998102354941   0.0090916395358   0.0198340652153
    -0.00432855821643 -0.00884436517728    0.999951519219   0.0551992192954
    0                 0                 0                 1
    ```
    
    - 最后得到的结果几乎相同，都在1ms内，说明3D-2D位姿估计并不是很耗时。同时采用单位阵作为初值迭代一次就得到结果，残差减小的非常有限。将初始值替换为EPNP算法解算得到的R与t后，得到的结果如下：`iteration= 0	 chi2= 1998.347512	 time= 1.8588e-05	 
    iteration= 1	 chi2= 1952.167066	 time= 7.479e-06	 cumTime= 2.6067e-05	 edges= 67 `可以看出对结果有一些帮助，但是在本例中不明显。
    - 与2d-2d的姿态估计方法pose_estimation_2d2d.cpp的结果相比，旋转矩阵的结果几乎一致，平移分量相差较大，可能是因为地图点的坐标不准确导致，在`hw_6.cpp`中对地图点坐标同时进行BA优化，得到的残差会明显小于pose ba得到的残差。

- pose_estimation_3d3d.cpp 使用ICP及优化算法求解位姿。
  - 特征匹配得到79组3D-3D特征点。通过ICP求解位姿估计问题以及pose-BA求解。
  - ICP求解耗时0.1ms，BA求解迭代8次耗时0.4ms。


- g2o_ba_example.cpp

  - 根据两张图片以及对应的特征匹配关系，得到初始三维地图点(深度未知)。用三维地图点和两帧图像的位姿做一个Full BA.并查看内点数量。

  - ![image-20211225193051782](https://tuchuang-1998.oss-accelerate.aliyuncs.com/Picgo/image-20211225193051782.png)

  - 匹配得到150组特征点，因此有300条边，以优化后的重投影误差1个像素为边界，最终得到243个内点。通过重投影误差可以很容易的剔除掉明显的误匹配。

- hw_6.cpp 在3d-2d位姿估计的基础上，将地图点的也作为优化变量考虑，同时对位姿和路标点进行优化。

    - 分别使用g2o自带类型与自定义类型来实现，迭代10次两种结果一致且自带类型耗与自定义类型耗时均为0.7ms左右。
    
    - ```sh
      iteration= 0	 chi2= 1099.376643	 time= 0.00435727	 cumTime= 0.00435727	 edges= 134	 schur= 1	 lambda= 70.635894	 levenbergIter= 1
      iteration= 1	 chi2= 423.494705	 time= 0.00435216	 cumTime= 0.00870943	 edges= 134	 schur= 1	 lambda= 47.090596	 levenbergIter= 1
      iteration= 2	 chi2= 122.625090	 time= 0.00416494	 cumTime= 0.0128744	 edges= 134	 schur= 1	 lambda= 15.696865	 levenbergIter= 1
      iteration= 3	 chi2= 27.257619	 time= 0.0041033	 cumTime= 0.0169777	 edges= 134	 schur= 1	 lambda= 5.232288	 levenbergIter= 1
      iteration= 4	 chi2= 24.507869	 time= 0.00439604	 cumTime= 0.0213737	 edges= 134	 schur= 1	 lambda= 1.744096	 levenbergIter= 1
      ```
    
    - ```sh
      pose estimated by g2o =
      0.998177 -0.0527726  0.0292778  -0.104437
      0.0518586   0.998169  0.0311439 -0.0134375
      -0.0308677 -0.0295688   0.999086  0.0350892
      0          0          0          1
      ```
    
- hw_7.cpp 在3D-3D位姿估计的基础，将地图点的也作为优化变量考虑，同时对位姿和路标点进行优化。

    - 使用自定义类型来实现，迭代10次两种结果一致且自带类型耗与自定义类型耗时均为0.7ms左右。
    
    - ```sh
      iteration= 0	 chi2= 0.001106	 time= 0.00490931	 cumTime= 0.00490931	 edges= 65	 schur= 1	 lambda= 0.000546	 levenbergIter= 1
      iteration= 1	 chi2= 0.000000	 time= 0.00462976	 cumTime= 0.00953907	 edges= 65	 schur= 1	 lambda= 0.000364	 levenbergIter= 1
      iteration= 2	 chi2= 0.000000	 time= 0.00471274	 cumTime= 0.0142518	 edges= 65	 schur= 1	 lambda= 0.000243	 levenbergIter= 1
      ```
    
    - ```sh
      T=
          0.998553   -0.0537536  -0.00144618   -0.0568891
         0.0537669     0.997668    0.0420416   -0.0318081
      -0.000817083   -0.0420585     0.999115     0.033552
                 0            0            0            1
      ```
    
    - 最后error是0，非常神奇。

## todo



- [ ] 从几何上理解对极约束的误差的来源。
- [ ] 本质矩阵的系数矩阵需要进一步的学习。比如求解E的时候，系数矩阵满秩，特征点处于什么情况下退化，不满秩，等等。
